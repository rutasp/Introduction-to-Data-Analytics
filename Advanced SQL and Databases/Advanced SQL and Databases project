SELECT
customer.customerID as CustomerID,
contact.Firstname,
contact.LastName,
CONCAT (contact.Firstname,' ',contact.LastName) Full_Name,
CONCAT (CASE
WHEN contact.Title IS NULL THEN 'Dear'
ELSE contact.Title
END,
 ', contact.LastName) addressing_title,
contact.Emailaddress,
contact.Phone,
customer.accountnumber,
customer.customertype,
address.City,
address.AddressLine1,
address.AddressLine2,
state_province.name AS state,
country_region.name AS country,
s_order.number_orders,
s_order.sum_total_due AS total_amount,
s_order.latest_order AS date_last_order
FROM `adwentureworks_db.customer`customer
JOIN
(SELECT
customerID,
ContactID,
COUNT(SalesOrderID) number_orders,
MAX(OrderDate) AS latest_order,
ROUND(SUM(TotalDue),3) AS sum_total_due
FROM `adwentureworks_db.salesorderheader` s_order
GROUP BY CustomerID, ContactID) AS s_order
ON s_order.customerID = customer.customerID
JOIN `adwentureworks_db.contact` contact
ON contact.ContactId = s_order.ContactID
JOIN
(SELECT
CustomerID,
MAX (AddressID) AS LatestAddressID
FROM `adwentureworks_db.customeraddress`
GROUP BY CustomerID) AS latest_address
ON latest_address.customerID = customer.customerID
JOIN `adwentureworks_db.address` address
ON address.AddressID = latest_address.LatestAddressID
JOIN `adwentureworks_db.stateprovince` state_province
ON state_province.StateProvinceID = address.StateProvinceID
JOIN `adwentureworks_db.countryregion`country_region
ON country_region.countryregioncode = state_province.CountryRegionCode
WHERE customer.customertype = 'I'
ORDER BY total_amount;
